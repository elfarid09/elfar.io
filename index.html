<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Full Music Player</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #121212; color: white; }
    input, button { padding: 8px; margin: 5px; }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; }
    .track { cursor: pointer; padding: 8px; background: #1db954; border-radius: 5px; }
  </style>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
  <h1>Spotify Music Player</h1>
  <p id="status">Menunggu token...</p>

  <div id="search-area" style="display:none;">
    <input type="text" id="searchInput" placeholder="Cari lagu di Spotify">
    <button onclick="searchTracks()">Cari</button>
    <ul id="results"></ul>
  </div>

  <script>
    const client_id = '2004365f23524bc5ae3234711c217c98';
    const client_secret = '2c4178f53b2a4a47bc75c6f1c9538e9a';
    const redirect_uri = 'https://elfarid09.github.io/elfar.io/';
    let access_token = '';
    let device_id = '';

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    async function getAccessToken(code) {
      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': 'Basic ' + btoa(client_id + ':' + client_secret)
        },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: redirect_uri
        })
      });

      const data = await response.json();
      if (data.access_token) {
        access_token = data.access_token;
        document.getElementById('status').textContent = 'Token diterima. Menyiapkan player...';
        initPlayer();
      } else {
        document.getElementById('status').textContent = 'Gagal ambil token.';
        console.error(data);
      }
    }

    function initPlayer() {
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Elfar Music Player',
          getOAuthToken: cb => cb(access_token),
          volume: 0.5
        });

        player.addListener('ready', ({ device_id: id }) => {
          device_id = id;
          document.getElementById('status').textContent = 'Player siap! Cari lagu di bawah.';
          document.getElementById('search-area').style.display = 'block';
        });

        player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
        });

        player.connect();
      };
    }

    async function searchTracks() {
      const query = document.getElementById('searchInput').value;
      const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
        headers: {
          Authorization: 'Bearer ' + access_token
        }
      });

      const data = await response.json();
      const results = document.getElementById('results');
      results.innerHTML = '';

      if (data.tracks && data.tracks.items) {
        data.tracks.items.forEach(track => {
          const li = document.createElement('li');
          li.innerHTML = `<div class="track" onclick="playTrack('${track.uri}')">${track.name} - ${track.artists[0].name}</div>`;
          results.appendChild(li);
        });
      } else {
        results.innerHTML = '<li>Tidak ditemukan</li>';
      }
    }

    function playTrack(uri) {
      fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ uris: [uri] })
      }).then(() => {
        document.getElementById('status').textContent = 'Memutar lagu...';
      });
    }

    if (code) {
      getAccessToken(code);
    } else {
      document.getElementById('status').innerHTML = `
        <a href="https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=code&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=streaming%20user-read-email%20user-read-private%20user-modify-playback-state">Login ke Spotify</a>
      `;
    }
  </script>
</body>
</html>
