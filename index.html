<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Web Playback SDK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #121212; color: white; }
        button { padding: 10px; background: #1DB954; color: white; border: none; cursor: pointer; }
        #player { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Login Spotify</h1>
    <button onclick="loginToSpotify()">Login with Spotify</button>
    <div id="player"></div>

    <script>
        const clientId = '2004365f23524bc5ae3234711c217c98';
        const redirectUri = 'https://elfarid09.github.io/elfar.io/';
        const scope = 'streaming user-read-email user-read-private user-library-read';
        const clientSecret = '2c4178f53b2a4a47bc75c6f1c9538e9a';
        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const tokenEndpoint = 'https://accounts.spotify.com/api/token';

        let accessToken = '';
        let player;

        // Step 1: Login to Spotify and get access token
        function loginToSpotify() {
            const authUrl = `${authEndpoint}?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}`;
            window.location.href = authUrl;
        }

        // Step 2: Get access token after user authorization
        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
                    },
                    body: `grant_type=authorization_code&code=${code}&redirect_uri=${encodeURIComponent(redirectUri)}`
                })
                .then(response => response.json())
                .then(data => {
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    window.history.pushState({}, null, '/');
                    setupPlayer();
                });
            }
        }

        // Step 3: Initialize Spotify Web Playback SDK
        function setupPlayer() {
            if (!accessToken) {
                accessToken = localStorage.getItem('access_token');
            }

            if (accessToken) {
                const script = document.createElement('script');
                script.src = 'https://sdk.scdn.co/spotify-player.js';
                script.onload = () => {
                    player = new Spotify.Player({
                        name: 'Web Playback SDK',
                        getOAuthToken: cb => { cb(accessToken); },
                        volume: 0.5
                    });

                    player.addListener('initialization_error', ({ message }) => console.error(message));
                    player.addListener('authentication_error', ({ message }) => console.error(message));
                    player.addListener('account_error', ({ message }) => console.error(message));
                    player.addListener('playback_error', ({ message }) => console.error(message));

                    player.addListener('player_state_changed', state => {
                        console.log(state);
                    });

                    player.addListener('ready', ({ device_id }) => {
                        console.log('The Web Playback SDK is ready with Device ID', device_id);
                        playMusic();
                    });

                    player.connect();
                };
                document.body.appendChild(script);
            } else {
                loginToSpotify();
            }
        }

        // Step 4: Play music
        function playMusic() {
            if (player) {
                player.resume().then(() => {
                    console.log('Playback started!');
                });
            }
        }

        window.onload = getTokenFromUrl;
    </script>
</body>
</html>
